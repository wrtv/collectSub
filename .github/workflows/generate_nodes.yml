name: generate_nodes

on:
  push:
    paths:
      - 'sub/sub_all_url_check.txt'
      - 'generate_nodes.py'
      - 'requirementsnodes.txt'
  workflow_dispatch:
    inputs:
      strict_dedup:
        description: 'ä½¿ç”¨ä¸¥æ ¼å»é‡æ¨¡å¼ï¼ˆè€ƒè™‘ network å’Œ security_methodï¼‰'
        required: false
        default: 'true'
  schedule:
    - cron: '0 0,12 * * *' # æ¯å¤© UTC 00:00 å’Œ 12:00 è¿è¡Œ

jobs:
  generate-nodes-list:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ç¼“å­˜è™šæ‹Ÿç¯å¢ƒ
        uses: actions/cache@v4
        id: cache-venv
        with:
          path: venv
          key: ${{ runner.os }}-venv-${{ hashFiles('requirementsnodes.txt') }}
          restore-keys: |
            ${{ runner.os }}-venv-

      - name: éªŒè¯ requirementsnodes.txt
        run: |
          if [ ! -f requirementsnodes.txt ]; then
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ° requirementsnodes.txt æ–‡ä»¶"
            exit 1
          fi
          while IFS= read -r line; do
            if [[ -z "$line" || "$line" =~ ^# ]]; then
                continue
            fi
            if ! echo "$line" | grep -qE '^[a-zA-Z0-9_-]+(>=|==|<|<=|~=)?[0-9.]*([a-zA-Z0-9_-]+)*$'; then
              echo "é”™è¯¯ï¼šrequirementsnodes.txt ä¸­æ ¼å¼æ— æ•ˆï¼š$line"
              exit 1
            fi
          done < requirementsnodes.txt
          echo "requirementsnodes.txt éªŒè¯é€šè¿‡"

      - name: åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
        if: steps.cache-venv.outputs.cache-hit != 'true'
        run: |
          python -m venv venv
          source venv/bin/activate
          python -m pip install --upgrade pip

      - name: å®‰è£…ä¾èµ–
        run: |
          source venv/bin/activate
          pip install -r requirementsnodes.txt
        env:
          PIP_NO_CACHE_DIR: 1

      - name: ç”ŸæˆèŠ‚ç‚¹
        # âš ï¸ æ·»åŠ äº† 'set -e'ï¼Œç¡®ä¿ä»»ä½•å‘½ä»¤å¤±è´¥éƒ½ä¼šå¯¼è‡´æ­¥éª¤ç«‹å³å¤±è´¥
        run: |
          set -e # ä»»ä½•éé›¶é€€å‡ºç çš„å‘½ä»¤éƒ½ä¼šå¯¼è‡´æ­¤æ­¥éª¤å¤±è´¥
          source venv/bin/activate
          set -x # å¼€å¯è°ƒè¯•æ¨¡å¼ï¼Œæ˜¾ç¤ºæ‰§è¡Œçš„å‘½ä»¤
          STRICT_DEDUP=${{ github.event.inputs.strict_dedup || 'true' }}
          
          PYTHON_CMD="python generate_nodes.py --output output/all_nodes.txt"
          if [ "$STRICT_DEDUP" = "true" ]; then
            PYTHON_CMD+=" --strict_dedup"
          fi
          
          # æ‰§è¡Œ Python è„šæœ¬ï¼Œå¹¶å°†è¾“å‡ºä¿å­˜åˆ°æ—¥å¿—æ–‡ä»¶ï¼ŒåŒæ—¶æ˜¾ç¤ºåœ¨æ§åˆ¶å°
          # ä»»ä½• Python è„šæœ¬å†…éƒ¨çš„é”™è¯¯ï¼ˆå¦‚æœå¯¼è‡´éé›¶é€€å‡ºï¼‰éƒ½ä¼šè¢« set -e æ•è·
          $PYTHON_CMD 2>&1 | tee generate_nodes.log
          
          # ç¡®ä¿ Python è„šæœ¬è¿è¡Œåï¼Œoutput/all_nodes.txt æ–‡ä»¶ç¡®å®å­˜åœ¨ä¸”ä¸ä¸ºç©º
          # å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨æˆ–ä¸ºç©ºï¼Œåˆ™å¼ºåˆ¶æ­¤æ­¥éª¤å¤±è´¥
          if [ ! -s output/all_nodes.txt ]; then
            echo "é”™è¯¯ï¼šgenerate_nodes.py è¿è¡Œåæœªç”Ÿæˆæœ‰æ•ˆæ–‡ä»¶ output/all_nodes.txt æˆ–æ–‡ä»¶ä¸ºç©ºï¼"
            exit 1
          fi
        env:
          PYTHONUNBUFFERED: 1 # ç¡®ä¿æ—¥å¿—å®æ—¶è¾“å‡º

      - name: åˆ—å‡º output ç›®å½•å†…å®¹ (è°ƒè¯•ç”¨) ğŸ”
        # è¿™ä¸ªæ­¥éª¤ç°åœ¨æ›´åƒæ˜¯ç¡®è®¤ï¼Œå¦‚æœä¸Šä¸€æ­¥æˆåŠŸï¼Œè¿™é‡Œåº”è¯¥ä¹Ÿèƒ½çœ‹åˆ°æ–‡ä»¶
        run: |
          echo "Listing contents of output/ directory:"
          ls -la output/
          echo "Listing contents of current directory:"
          ls -la .

      - name: éªŒè¯è¾“å‡ºæ–‡ä»¶
        run: |
          if [ ! -f output/all_nodes.txt ]; then
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ° output/all_nodes.txt æ–‡ä»¶"
            exit 1
          fi
          if [ ! -s output/all_nodes.txt ]; then
            echo "é”™è¯¯ï¼šoutput/all_nodes.txt æ–‡ä»¶ä¸ºç©º"
            exit 1
          fi
          if ! grep -qE '^(ss|ssr|vmess|vless|trojan|hysteria|hy|hy2)://' output/all_nodes.txt; then
            echo "é”™è¯¯ï¼šoutput/all_nodes.txt ä¸åŒ…å«æœ‰æ•ˆçš„èŠ‚ç‚¹ URL"
            exit 1
          fi
          LINES=$(wc -l < output/all_nodes.txt)
          echo "output/all_nodes.txt ä¸­çš„èŠ‚ç‚¹æ•°ï¼š$LINES"
          echo "æ€»èŠ‚ç‚¹æ•°ï¼š$LINES"
          echo "=== èŠ‚ç‚¹å¤„ç†ç»Ÿè®¡ ==="
          grep -A 10 "=== èŠ‚ç‚¹å¤„ç†ç»Ÿè®¡ ===" generate_nodes.log || echo "æ—¥å¿—ä¸­æœªæ‰¾åˆ°ç»Ÿè®¡ä¿¡æ¯"

      - name: ä¸Šä¼ å·¥ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: nodes
          path: |
            output/all_nodes.txt
            generate_nodes.log
          if-no-files-found: error

      - name: æäº¤å¹¶æ¨é€æ›´æ”¹
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git status

          git add .

          if git diff --quiet --staged; then
            echo "æ— æ›´æ”¹éœ€è¦æäº¤"
            exit 0
          fi

          TOTAL_NODES=$(wc -l output/all_nodes.txt | awk '{print $1}')
          STRICT_MODE=$([[ "${{ github.event.inputs.strict_dedup || 'true' }}" == "true" ]] && echo "ä¸¥æ ¼" || echo "å®½æ¾")
          
          git commit -m "æ›´æ–°èŠ‚ç‚¹åˆ—è¡¨ï¼š$TOTAL_NODES ä¸ªèŠ‚ç‚¹ï¼ˆ$STRICT_MODE å»é‡æ¨¡å¼ï¼‰[skip ci]"

          git pull --rebase origin main
          
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
